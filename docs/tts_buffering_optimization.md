# TTSéŸ³é¢‘å—ç¼“å†²åˆå¹¶ä¼˜åŒ–æ–¹æ¡ˆ

## é—®é¢˜èƒŒæ™¯

åœ¨ä½¿ç”¨just_audioå®ç°ç±»ä¼¼HLSçš„TTSæµå¼æ’­æ”¾æ—¶ï¼Œç”¨æˆ·åæ˜ æ’­æ”¾æ—¶ä¼šå‡ºç°å¡é¡¿ç°è±¡ã€‚è¿™ä¸»è¦æ˜¯ç”±äºï¼š

1. **é¢‘ç¹çš„æ–‡ä»¶åˆ‡æ¢**ï¼šæ¯ä¸ªå°çš„éŸ³é¢‘å—éƒ½æ˜¯ç‹¬ç«‹æ–‡ä»¶ï¼Œåˆ‡æ¢æ—¶å¯èƒ½äº§ç”Ÿå¾®å°é—´éš™
2. **æ’­æ”¾å™¨å¤„ç†å¼€é”€**ï¼šjust_audioåœ¨å¤„ç†å¤§é‡å°æ–‡ä»¶æ—¶çš„æ€§èƒ½å¼€é”€
3. **ç³»ç»ŸI/Oå‹åŠ›**ï¼šé¢‘ç¹çš„æ–‡ä»¶è¯»å–æ“ä½œ

## è§£å†³æ–¹æ¡ˆï¼šéŸ³é¢‘å—ç¼“å†²åˆå¹¶

### æ ¸å¿ƒæ€æƒ³

å°†å¤šä¸ªå°çš„éŸ³é¢‘å—åˆå¹¶ä¸ºè¾ƒå¤§çš„éŸ³é¢‘æ®µï¼Œå‡å°‘æ’­æ”¾åˆ—è¡¨ä¸­çš„æ–‡ä»¶æ•°é‡ï¼Œä»è€Œå‡å°‘åˆ‡æ¢æ¬¡æ•°å’Œå¡é¡¿ç°è±¡ã€‚

### æŠ€æœ¯å®ç°

#### 1. é…ç½®å‚æ•°

åœ¨ `TTSConfig` ä¸­æ–°å¢ä»¥ä¸‹é…ç½®é€‰é¡¹ï¼š

```dart
// æ¯ä¸ªæ’­æ”¾æ®µåŒ…å«çš„éŸ³é¢‘å—æ•°é‡
int chunksPerSegment = 5;

// æ˜¯å¦å¯ç”¨éŸ³é¢‘å—åˆå¹¶
bool chunkMergingEnabled = true;

// ç¬¬ä¸€æ®µçš„ç‰¹æ®Šå¤„ç†ï¼ˆå‡å°‘åˆå§‹å»¶è¿Ÿï¼‰
bool fastFirstSegment = true;
```

#### 2. ç¼“å†²æœºåˆ¶

```dart
// éŸ³é¢‘å—ç¼“å†²åŒº
List<Uint8List> _audioChunkBuffer = [];

// æ®µè®¡æ•°å™¨
int _segmentCounter = 0;

// æ˜¯å¦ä¸ºç¬¬ä¸€æ®µ
bool _isFirstSegment = true;
```

#### 3. å¤„ç†æµç¨‹

1. **æ¥æ”¶éŸ³é¢‘å—** â†’ æ·»åŠ åˆ°ç¼“å†²åŒº
2. **æ£€æŸ¥åˆå¹¶æ¡ä»¶** â†’ è¾¾åˆ°æŒ‡å®šæ•°é‡æˆ–æ¶ˆæ¯ç»“æŸ
3. **åˆå¹¶éŸ³é¢‘æ•°æ®** â†’ å°†å¤šä¸ªå—çš„å­—èŠ‚æ•°æ®æ‹¼æ¥
4. **åˆ›å»ºéŸ³é¢‘æ®µ** â†’ ä¿å­˜ä¸ºå•ä¸ªæ–‡ä»¶
5. **æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨** â†’ ä½¿ç”¨just_audioæ’­æ”¾

### ä¼˜åŒ–ç­–ç•¥

#### ç¬¬ä¸€æ®µå¿«é€Ÿæ’­æ”¾

```dart
if (_isFirstSegment && _config.fastFirstSegment) {
  // ç¬¬ä¸€æ®µï¼šæ”¶åˆ°ç¬¬ä¸€ä¸ªå—å°±ç«‹å³æ’­æ”¾ï¼ˆå‡å°‘å»¶è¿Ÿï¼‰
  shouldCreateSegment = _audioChunkBuffer.length >= 1;
} else {
  // åç»­æ®µï¼šç­‰å¾…æŒ‡å®šæ•°é‡çš„å—
  shouldCreateSegment = _audioChunkBuffer.length >= _config.chunksPerSegment;
}
```

#### éŸ³é¢‘æ•°æ®åˆå¹¶

```dart
Uint8List _mergeAudioChunks(List<Uint8List> chunks) {
  // è®¡ç®—æ€»é•¿åº¦
  int totalLength = chunks.fold(0, (sum, chunk) => sum + chunk.length);
  
  // åˆ›å»ºåˆå¹¶åçš„æ•°æ®
  final mergedData = Uint8List(totalLength);
  int offset = 0;
  
  for (final chunk in chunks) {
    mergedData.setRange(offset, offset + chunk.length, chunk);
    offset += chunk.length;
  }
  
  return mergedData;
}
```

## æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰ï¼ˆå•å—æ¨¡å¼ï¼‰

- **æ–‡ä»¶æ•°é‡**ï¼šNä¸ªéŸ³é¢‘å— = Nä¸ªæ–‡ä»¶
- **åˆ‡æ¢æ¬¡æ•°**ï¼šN-1æ¬¡æ–‡ä»¶åˆ‡æ¢
- **æ½œåœ¨å¡é¡¿ç‚¹**ï¼šæ¯æ¬¡åˆ‡æ¢éƒ½å¯èƒ½äº§ç”Ÿé—´éš™

### ä¼˜åŒ–åï¼ˆç¼“å†²åˆå¹¶æ¨¡å¼ï¼‰

- **æ–‡ä»¶æ•°é‡**ï¼šNä¸ªéŸ³é¢‘å— = N/5ä¸ªæ®µæ–‡ä»¶
- **åˆ‡æ¢æ¬¡æ•°**ï¼š(N/5)-1æ¬¡æ–‡ä»¶åˆ‡æ¢
- **æ½œåœ¨å¡é¡¿ç‚¹**ï¼šå‡å°‘80%çš„åˆ‡æ¢ç‚¹

## é…ç½®å»ºè®®

### ä¸åŒåœºæ™¯çš„æ¨èé…ç½®

#### 1. ä½å»¶è¿Ÿåœºæ™¯ï¼ˆå®æ—¶å¯¹è¯ï¼‰
```dart
config.setChunksPerSegment(3);        // è¾ƒå°çš„æ®µ
config.setFastFirstSegment(true);     // å¿«é€Ÿå¼€å§‹
```

#### 2. æµç•…æ’­æ”¾åœºæ™¯ï¼ˆé•¿æ–‡æœ¬æœ—è¯»ï¼‰
```dart
config.setChunksPerSegment(8);        // è¾ƒå¤§çš„æ®µ
config.setFastFirstSegment(false);    // ç­‰å¾…æ›´å¤šç¼“å†²
```

#### 3. ç½‘ç»œä¸ç¨³å®šåœºæ™¯
```dart
config.setChunksPerSegment(5);        // ä¸­ç­‰å¤§å°
config.setFastFirstSegment(true);     // å¿«é€Ÿå¼€å§‹
```

## ä½¿ç”¨æ–¹æ³•

### 1. å¯ç”¨ç¼“å†²åˆå¹¶

```dart
final config = TTSConfig.instance;
config.setChunkMergingEnabled(true);
config.setChunksPerSegment(5);
```

### 2. å¤„ç†éŸ³é¢‘æµ

```dart
final ttsService = PlaylistTTSService();
await ttsService.initialize();

// å¤„ç†éŸ³é¢‘å—ï¼ˆè‡ªåŠ¨ç¼“å†²åˆå¹¶ï¼‰
for (final audioChunk in audioChunks) {
  await ttsService.processTTSChunk(messageId, audioChunk);
}

// å®Œæˆå¤„ç†ï¼ˆå¤„ç†å‰©ä½™å—ï¼‰
await ttsService.finishTTSMessage(messageId);
```

### 3. åŠ¨æ€è°ƒæ•´å‚æ•°

```dart
// æ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´
if (networkSlow) {
  config.setChunksPerSegment(3);  // å‡å°‘ç¼“å†²
} else {
  config.setChunksPerSegment(8);  // å¢åŠ ç¼“å†²
}
```

## ç›®å½•ç»“æ„

```
temp/
â”œâ”€â”€ tts_chunks/          # åŸå§‹éŸ³é¢‘å—ï¼ˆè°ƒè¯•ç”¨ï¼‰
â”‚   â””â”€â”€ message_001/
â”‚       â”œâ”€â”€ chunk_000.wav
â”‚       â””â”€â”€ chunk_001.wav
â”œâ”€â”€ tts_segments/        # åˆå¹¶åçš„éŸ³é¢‘æ®µ
â”‚   â””â”€â”€ message_001/
â”‚       â”œâ”€â”€ segment_000.wav  # åŒ…å«chunk 0-4
â”‚       â””â”€â”€ segment_001.wav  # åŒ…å«chunk 5-9
â””â”€â”€ tts_complete/        # å®Œæ•´éŸ³é¢‘æ–‡ä»¶ï¼ˆç¼“å­˜ï¼‰
    â””â”€â”€ message_001.wav
```

## å…¼å®¹æ€§

- âœ… **å‘åå…¼å®¹**ï¼šå¯ä»¥é€šè¿‡é…ç½®ç¦ç”¨åˆå¹¶åŠŸèƒ½
- âœ… **æ¸è¿›å¼ä¼˜åŒ–**ï¼šå¯ä»¥åŠ¨æ€è°ƒæ•´å‚æ•°
- âœ… **é™çº§æ”¯æŒ**ï¼šåˆå¹¶å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°å•å—æ¨¡å¼

## ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—è¾“å‡º

```
ğŸ“¦ [PlaylistTTS] å¤„ç†éŸ³é¢‘å— 1 (ç¼“å†²æ¨¡å¼)
ğŸµ [PlaylistTTS] åˆ›å»ºéŸ³é¢‘æ®µ 1ï¼ŒåŒ…å« 1 ä¸ªéŸ³é¢‘å—
ğŸ“¦ [PlaylistTTS] å¤„ç†éŸ³é¢‘å— 2 (ç¼“å†²æ¨¡å¼)
ğŸ“¦ [PlaylistTTS] å¤„ç†éŸ³é¢‘å— 3 (ç¼“å†²æ¨¡å¼)
ğŸµ [PlaylistTTS] åˆ›å»ºéŸ³é¢‘æ®µ 2ï¼ŒåŒ…å« 5 ä¸ªéŸ³é¢‘å—
ğŸ¯ [PlaylistTTS] å¤„ç†å‰©ä½™çš„ 2 ä¸ªéŸ³é¢‘å—
âœ… [PlaylistTTS] æ¶ˆæ¯ message_001 çš„æ‰€æœ‰éŸ³é¢‘å—å·²æ¥æ”¶å®Œæˆ
```

### æ€§èƒ½æŒ‡æ ‡

å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç›‘æ§ä¼˜åŒ–æ•ˆæœï¼š

```dart
final status = ttsService.getPlaybackStatus();
print('æ®µæ•°é‡: ${status['segmentCount']}');
print('æ€»å—æ•°: ${status['chunkCount']}');
print('å‹ç¼©æ¯”: ${status['chunkCount'] / status['segmentCount']}');
```

## æ€»ç»“

é€šè¿‡éŸ³é¢‘å—ç¼“å†²åˆå¹¶æœºåˆ¶ï¼Œæˆ‘ä»¬æˆåŠŸåœ°ï¼š

1. **å‡å°‘äº†80%çš„æ–‡ä»¶åˆ‡æ¢æ¬¡æ•°**
2. **æ˜¾è‘—æ”¹å–„äº†æ’­æ”¾æµç•…åº¦**
3. **ä¿æŒäº†ä½å»¶è¿Ÿçš„ç”¨æˆ·ä½“éªŒ**
4. **æä¾›äº†çµæ´»çš„é…ç½®é€‰é¡¹**

è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆæœ‰æ•ˆè§£å†³äº†TTSæµå¼æ’­æ”¾çš„å¡é¡¿é—®é¢˜ï¼ŒåŒæ—¶ä¿æŒäº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚