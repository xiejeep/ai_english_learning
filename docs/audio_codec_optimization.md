# Android éŸ³é¢‘ç¼–è§£ç å™¨ä¼˜åŒ–æŒ‡å—

## ğŸš¨ BAD_INDEX é”™è¯¯åˆ†æ

### é”™è¯¯ç°è±¡
```
I/CCodecConfig( 9558): query failed after returning 8 values (BAD_INDEX)
W/Codec2Client( 9558): query -- param skipped: index = 1342179345.
W/Codec2Client( 9558): query -- param skipped: index = 2415921170.
```

### é”™è¯¯åŸå› 

#### 1. **ç¡¬ä»¶ç¼–è§£ç å™¨å…¼å®¹æ€§é—®é¢˜**
- Android è®¾å¤‡çš„ç¡¬ä»¶ç¼–è§£ç å™¨ä¸éŸ³é¢‘æ ¼å¼ä¸å®Œå…¨å…¼å®¹
- ç³»ç»Ÿå°è¯•æŸ¥è¯¢ä¸æ”¯æŒçš„ç¼–è§£ç å™¨å‚æ•°æ—¶è¿”å› BAD_INDEX
- è¿™æ˜¯ Android MediaCodec æ¡†æ¶çš„å¸¸è§è­¦å‘Šï¼Œé€šå¸¸ä¸å½±å“æ’­æ”¾åŠŸèƒ½

#### 2. **éŸ³é¢‘å‚æ•°é…ç½®é—®é¢˜**
- æŸäº›é‡‡æ ·ç‡åœ¨ç‰¹å®šè®¾å¤‡ä¸Šå¯èƒ½è§¦å‘ç¼–è§£ç å™¨æŸ¥è¯¢é—®é¢˜
- éŸ³é¢‘æ ¼å¼å‚æ•°å¯èƒ½ä¸æ˜¯è®¾å¤‡çš„æœ€ä¼˜é…ç½®

#### 3. **just_audio æ’ä»¶åº•å±‚å®ç°**
- just_audio åœ¨ Android å¹³å°ä½¿ç”¨ ExoPlayer
- ExoPlayer ä¼šå°è¯•æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„ç¼–è§£ç å™¨èƒ½åŠ›
- æŸ¥è¯¢è¿‡ç¨‹ä¸­é‡åˆ°ä¸æ”¯æŒçš„å‚æ•°ä¼šäº§ç”Ÿè¿™äº›è­¦å‘Š

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### 1. **éŸ³é¢‘å‚æ•°ä¼˜åŒ–**

#### é‡‡æ ·ç‡ä¼˜åŒ–
```dart
// åŸé…ç½®ï¼ˆå¯èƒ½å¯¼è‡´å…¼å®¹æ€§é—®é¢˜ï¼‰
int get sampleRate => 16000;

// ä¼˜åŒ–é…ç½®ï¼ˆæ›´å¥½çš„ç¡¬ä»¶å…¼å®¹æ€§ï¼‰
int get sampleRate => 22050;
```

**æ¨èé‡‡æ ·ç‡**ï¼š
- `22050 Hz` - æœ€ä½³å…¼å®¹æ€§ï¼Œå¤§å¤šæ•°è®¾å¤‡æ”¯æŒ
- `44100 Hz` - é«˜è´¨é‡ï¼Œä½†å¯èƒ½å¢åŠ å¤„ç†å¼€é”€
- `48000 Hz` - ä¸“ä¸šçº§è´¨é‡ï¼Œéƒ¨åˆ†è®¾å¤‡å¯èƒ½ä¸æ”¯æŒ

#### ç¼“å†²åŒºå¤§å°ä¼˜åŒ–
```dart
// ä¼˜åŒ–ç¼“å†²åŒºå¤§å°ä»¥å‡å°‘ç¼–è§£ç å™¨æŸ¥è¯¢é¢‘ç‡
int get audioBufferSize => 4096; // 4KB
```

### 2. **ç¼–è§£ç å™¨ç­–ç•¥é…ç½®**

#### ç¦ç”¨ç¡¬ä»¶åŠ é€Ÿï¼ˆå¦‚æœé—®é¢˜ä¸¥é‡ï¼‰
```dart
// åœ¨ TTSConfig ä¸­æ·»åŠ 
bool _hardwareAccelerationEnabled = false;

// ä½¿ç”¨æ–¹æ³•
TTSConfig.instance.setHardwareAccelerationEnabled(false);
```

#### å¼ºåˆ¶ä½¿ç”¨è½¯ä»¶è§£ç å™¨
```dart
// é¿å…ç¡¬ä»¶å…¼å®¹æ€§é—®é¢˜
bool _useSoftwareDecoder = true;

// ä½¿ç”¨æ–¹æ³•
TTSConfig.instance.setUseSoftwareDecoder(true);
```

### 3. **just_audio æ’­æ”¾å™¨é…ç½®ä¼˜åŒ–**

#### åœ¨ PlaylistTTSService ä¸­æ·»åŠ æ’­æ”¾å™¨é…ç½®
```dart
Future<void> initialize() async {
  if (_isInitialized) return;
  
  try {
    _player = AudioPlayer();
    
    // é…ç½®æ’­æ”¾å™¨ä»¥å‡å°‘ç¼–è§£ç å™¨æŸ¥è¯¢
    await _player!.setAudioSource(
      _playlist!,
      preload: false, // å‡å°‘é¢„åŠ è½½æ—¶çš„ç¼–è§£ç å™¨æŸ¥è¯¢
    );
    
    _isInitialized = true;
  } catch (e) {
    // é”™è¯¯å¤„ç†
  }
}
```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### 1. **æ—¥å¿—è¿‡æ»¤**
è¿™äº› BAD_INDEX é”™è¯¯é€šå¸¸æ˜¯ç³»ç»Ÿçº§è­¦å‘Šï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿‡æ»¤ï¼š

```bash
# è¿‡æ»¤æ‰ MediaCodec ç›¸å…³çš„è­¦å‘Š
adb logcat | grep -v "CCodecConfig\|Codec2Client"
```

### 2. **æ€§èƒ½ç›‘æ§**
```dart
// ç›‘æ§éŸ³é¢‘æ’­æ”¾æ€§èƒ½
class AudioPerformanceMonitor {
  static void logCodecWarnings(String message) {
    if (message.contains('BAD_INDEX')) {
      print('âš ï¸ [Audio Codec] ç¼–è§£ç å™¨å…¼å®¹æ€§è­¦å‘Š: $message');
      // å¯ä»¥é€‰æ‹©å¿½ç•¥æˆ–è®°å½•ç»Ÿè®¡
    }
  }
}
```

### 3. **è®¾å¤‡å…¼å®¹æ€§æµ‹è¯•**
```dart
// æ£€æµ‹è®¾å¤‡çš„éŸ³é¢‘ç¼–è§£ç å™¨æ”¯æŒæƒ…å†µ
class AudioCompatibilityChecker {
  static Future<bool> checkCodecSupport() async {
    try {
      // æµ‹è¯•æ’­æ”¾ä¸€ä¸ªå°çš„éŸ³é¢‘æ–‡ä»¶
      final player = AudioPlayer();
      // ... æµ‹è¯•é€»è¾‘
      return true;
    } catch (e) {
      print('âŒ [Audio Codec] è®¾å¤‡å…¼å®¹æ€§é—®é¢˜: $e');
      return false;
    }
  }
}
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. **é…ç½®ä¼˜å…ˆçº§**
1. **é¦–é€‰**ï¼šä½¿ç”¨è½¯ä»¶è§£ç å™¨ + 22050Hz é‡‡æ ·ç‡
2. **å¤‡é€‰**ï¼šç¦ç”¨ç¡¬ä»¶åŠ é€Ÿ
3. **æœ€å**ï¼šé™ä½éŸ³é¢‘è´¨é‡å‚æ•°

### 2. **é”™è¯¯å¤„ç†ç­–ç•¥**
```dart
// åœ¨éŸ³é¢‘æ’­æ”¾å¤±è´¥æ—¶çš„é™çº§ç­–ç•¥
Future<void> playWithFallback() async {
  try {
    // å°è¯•æ­£å¸¸æ’­æ”¾
    await _player!.play();
  } catch (e) {
    if (e.toString().contains('codec') || e.toString().contains('BAD_INDEX')) {
      // åˆ‡æ¢åˆ°è½¯ä»¶è§£ç å™¨é‡è¯•
      TTSConfig.instance.setUseSoftwareDecoder(true);
      await _player!.play();
    }
  }
}
```

### 3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
- è¿™äº›é”™è¯¯é€šå¸¸ä¸å½±å“å®é™…æ’­æ”¾åŠŸèƒ½
- å¯ä»¥åœ¨æ—¥å¿—ä¸­æ ‡è®°ä¸º"å…¼å®¹æ€§è­¦å‘Š"è€Œé"é”™è¯¯"
- æä¾›ç”¨æˆ·è®¾ç½®é€‰é¡¹æ¥è°ƒæ•´éŸ³é¢‘å‚æ•°

## ğŸ“ æ€»ç»“

BAD_INDEX é”™è¯¯ä¸»è¦æ˜¯ Android ç³»ç»Ÿå±‚é¢çš„ç¼–è§£ç å™¨å…¼å®¹æ€§è­¦å‘Šï¼Œé€šå¸¸ä¸ä¼šå½±å“éŸ³é¢‘æ’­æ”¾åŠŸèƒ½ã€‚é€šè¿‡ä¼˜åŒ–éŸ³é¢‘å‚æ•°é…ç½®å’Œä½¿ç”¨è½¯ä»¶è§£ç å™¨ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘è¿™äº›è­¦å‘Šçš„å‡ºç°ã€‚

**å…³é”®æ”¹è¿›**ï¼š
- âœ… é‡‡æ ·ç‡ä» 16000Hz ä¼˜åŒ–ä¸º 22050Hz
- âœ… é»˜è®¤ä½¿ç”¨è½¯ä»¶è§£ç å™¨
- âœ… æ·»åŠ ç¡¬ä»¶åŠ é€Ÿæ§åˆ¶é€‰é¡¹
- âœ… ä¼˜åŒ–éŸ³é¢‘ç¼“å†²åŒºå¤§å°
- âœ… æä¾›é™çº§æ’­æ”¾ç­–ç•¥